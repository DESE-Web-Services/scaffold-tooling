---
image: quay.io/tobybellwood/govcms-ci
services:
  - "docker:dind"
stages:
  - static
  - integration
  - audit
  - deploy
before_script:
  - composer install
  - ./vendor/govcms/scaffold-tooling/gitlab/setup-static.sh
variables:
  extends: .variables
  DOCKER_HOST: "tcp://localhost:2375"
  DOCKER_REGISTRY: "gitlab-registry-production.govcms.amazee.io"
  GITLAB_PROJECT: "dof-dev/govcms8-demo-ci"

.setup_static: &setup_static
  - composer install
  - ./vendor/govcms/scaffold-tooling/gitlab/setup-static.sh
.setup_full: &setup_full
  - composer install
  - ./vendor/govcms/scaffold-tooling/gitlab/setup-static.sh

vet:
  before_script:
    <<: *setup_static
  script:
    - echo "We'll run verification here"
  stage: static
static:
  before_script:
    <<: *setup_static
  script:
    - docker-compose exec -T test lint web/modules/custom
    - docker-compose exec -T test lint web/themes/custom
    - docker-compose exec -T test phpunit web/modules/custom
  stage: static
functional:
  extends: .func
  artifacts:
    expire_in: "7 days"
    paths:
      - tests/behat/features/screenshots
  before_script:
    <<: *setup_full
  script:
    - docker-compose exec -T test behat
  except:
    variables:
      - "$CI_COMMIT_MESSAGE =~ /GovCMS-Migration/"
  stage: integration
audit:
  before_script:
    <<: *setup_full
  script:
    - date
    - "ahoy audit-site"
  only:
    - merge_requests
  stage: audit
audit_manual:
  before_script:
    <<: *setup_full
  script:
    - "ahoy audit-site"
  when: manual
  stage: audit
deploy:
  script:
    - "echo \"curl -X POST -d projectName=$CI_PROJECT_NAME -d branchName=$CI_COMMIT_REF_NAME http://rest2tasks.lagoon.svc:3000/deploy\""
    - "curl -X POST -d projectName=$CI_PROJECT_NAME -d branchName=$CI_COMMIT_REF_NAME http://rest2tasks.lagoon.svc:3000/deploy"
  stage: deploy
